<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Palm Sender</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    video { display: none; }
    canvas { position: absolute; top: 0; left: 0; }
    body { margin: 0; background: #000; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script type="module">
    // ✅ Firebase Modular SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // 🔹 Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDrZDZ_M_DC97zLxLw4hgxwm_revSjwkMA",
      authDomain: "project-jarvis-creators.firebaseapp.com",
      projectId: "project-jarvis-creators",
      storageBucket: "project-jarvis-creators.firebasestorage.app",
      messagingSenderId: "489774215647",
      appId: "1:489774215647:web:9f4c6d2b48d6203ea6d46a",
      measurementId: "G-J40BFX6RET",
      databaseURL: "https://project-jarvis-creators-default-rtdb.firebaseio.com" // ⚠️ add this manually
    };

    // ✅ Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 🔹 Camera + Mediapipe
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let palmDetected = false, detectionStart = null, sent = false;
    let currentImage = "pic1"; // change this depending on image shown

    async function main() {
      const hands = new Hands({ locateFile: (file) => 
        `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });
      hands.setOptions({
        maxNumHands: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
      });

      hands.onResults(results => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.multiHandLandmarks.length > 0) {
          if (!palmDetected) {
            palmDetected = true;
            detectionStart = Date.now();
            sent = false;
          } else if (!sent && Date.now() - detectionStart > 2000) {
            // ✅ Send code to Firebase
            set(ref(db, "palmData"), {
              code: currentImage,
              time: Date.now()
            });
            console.log("Sent:", currentImage);
            sent = true;
          }
        } else {
          palmDetected = false;
          detectionStart = null;
        }
      });

      const camera = new Camera(video, {
        onFrame: async () => { await hands.send({ image: video }); },
        width: 640, height: 480
      });
      camera.start();

      canvas.width = 640;
      canvas.height = 480;
    }

    main();
  </script>
</body>
</html>
