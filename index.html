<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Palm Gallery Sender</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; overflow: hidden;
      background: #000; color: white;
      font-family: Arial, sans-serif;
    }
    #gallery {
      position: relative;
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    #gallery img {
      position: absolute;
      width: 100%; height: 100%;
      object-fit: contain;
      opacity: 0; transition: opacity 0.6s ease;
    }
    #gallery img.active { opacity: 1; }
    #canvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="gallery">
    <!-- demo images -->
    <img src="https://picsum.photos/id/1011/800/600" class="active" data-code="pic1">
    <img src="https://picsum.photos/id/1015/800/600" data-code="pic2">
    <img src="https://picsum.photos/id/1025/800/600" data-code="pic3">
    <canvas id="canvas"></canvas>
  </div>

  <video id="video" autoplay playsinline style="display:none"></video>

  <script type="module">
    // âœ… Firebase Modular SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDrZDZ_M_DC97zLxLw4hgxwm_revSjwkMA",
      authDomain: "project-jarvis-creators.firebaseapp.com",
      projectId: "project-jarvis-creators",
      storageBucket: "project-jarvis-creators.firebasestorage.app",
      messagingSenderId: "489774215647",
      appId: "1:489774215647:web:9f4c6d2b48d6203ea6d46a",
      measurementId: "G-J40BFX6RET",
      databaseURL: "https://project-jarvis-creators-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ðŸ”¹ Gallery logic
    const images = document.querySelectorAll("#gallery img");
    let currentIndex = 0;
    function showImage(i) {
      images.forEach(img => img.classList.remove("active"));
      images[i].classList.add("active");
    }
    function nextImage() {
      currentIndex = (currentIndex + 1) % images.length;
      showImage(currentIndex);
    }
    function prevImage() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      showImage(currentIndex);
    }
    // Swipe gestures
    let startX = 0;
    document.addEventListener("touchstart", e => startX = e.touches[0].clientX);
    document.addEventListener("touchend", e => {
      let endX = e.changedTouches[0].clientX;
      if (endX - startX > 50) prevImage();
      if (startX - endX > 50) nextImage();
    });
    // Keyboard
    document.addEventListener("keydown", e => {
      if (e.key === "ArrowRight") nextImage();
      if (e.key === "ArrowLeft") prevImage();
    });

    // ðŸ”¹ Mediapipe Hand Detection
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let palmDetected = false, detectionStart = null, sent = false;

    function drawAnimation(showTick) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const x = canvas.width / 2;
      const y = canvas.height / 2;
      ctx.beginPath();
      ctx.arc(x, y, 80, 0, Math.PI * 2);
      ctx.strokeStyle = "cyan";
      ctx.lineWidth = 4;
      ctx.stroke();
      if (showTick) {
        ctx.font = "80px Arial";
        ctx.fillStyle = "lime";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("âœ”", x, y);
      }
    }

    async function main() {
      const hands = new Hands({ locateFile: f => 
        `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` 
      });
      hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

      hands.onResults(results => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.multiHandLandmarks.length > 0) {
          if (!palmDetected) {
            palmDetected = true;
            detectionStart = Date.now();
            sent = false;
          } else {
            const elapsed = Date.now() - detectionStart;
            if (elapsed > 2000 && !sent) {
              const code = images[currentIndex].dataset.code;
              set(ref(db, "palmData"), { code, time: Date.now() });
              console.log("Sent:", code);
              sent = true;
              drawAnimation(true);
            } else {
              drawAnimation(false);
            }
          }
        } else {
          palmDetected = false;
          detectionStart = null;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      });

      const camera = new Camera(video, {
        onFrame: async () => { await hands.send({ image: video }); },
        width: 640, height: 480
      });
      camera.start();
      canvas.width = 640; canvas.height = 480;
    }

    main();
  </script>
</body>
</html>
