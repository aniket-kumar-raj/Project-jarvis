<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Palm Detection with Animation</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
  <style>
    body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: #111; }
    canvas { position: absolute; top: 0; left: 0; }
    video { display: none; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let model, palmDetected = false, detectionStart = null, showTick = false;
    let rotation = 0;
    let lastDetection = null;
    let lastPrediction = [];

    // Animation effect parameters
    let pulse = 0;
    let pulseIncreasing = true;

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" }, width: 640, height: 480 }
      });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve(video);
      });
    }

    // Only run hand detection every N ms to reduce lag
    const DETECTION_INTERVAL = 100; // ms

    async function detectHands() {
      const now = Date.now();
      if (!lastDetection || now - lastDetection > DETECTION_INTERVAL) {
        lastPrediction = await model.estimateHands(video, true);
        lastDetection = now;
      }

      if (lastPrediction.length > 0) {
        // Palm detected
        if (!palmDetected) {
          palmDetected = true;
          detectionStart = Date.now();
          showTick = false;
        } else if (Date.now() - detectionStart > 2000) {
          showTick = true;
        }
      } else {
        // No palm, reset
        palmDetected = false;
        detectionStart = null;
        showTick = false;
      }
    }

    function drawAnimation() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (palmDetected) {
        const x = canvas.width / 2;
        const y = canvas.height / 2;

        // Pulse effect for circle radius
        if (pulseIncreasing) {
          pulse += 1;
          if (pulse > 20) pulseIncreasing = false;
        } else {
          pulse -= 1;
          if (pulse < 0) pulseIncreasing = true;
        }

        // Rotating glowing circles
        rotation += 0.08; // Faster rotation

        // Outer glowing circle
        ctx.save();
        ctx.shadowColor = "cyan";
        ctx.shadowBlur = 30;
        ctx.beginPath();
        ctx.arc(x, y, 80 + pulse, 0, Math.PI * 2);
        ctx.strokeStyle = "cyan";
        ctx.lineWidth = 4;
        ctx.stroke();
        ctx.restore();

        // Animated arc
        ctx.save();
        ctx.shadowColor = "lime";
        ctx.shadowBlur = 30;
        ctx.beginPath();
        ctx.arc(x, y, 80 + pulse, rotation, rotation + Math.PI / 1.5);
        ctx.strokeStyle = "lime";
        ctx.lineWidth = 8;
        ctx.stroke();
        ctx.restore();

        // Particles around detected palm (simple sparkle)
        for (let i = 0; i < 12; i++) {
          const angle = rotation + (i * Math.PI / 6);
          const px = x + Math.cos(angle) * (100 + pulse);
          const py = y + Math.sin(angle) * (100 + pulse);
          ctx.save();
          ctx.globalAlpha = 0.5 + Math.sin(rotation + i) * 0.5;
          ctx.beginPath();
          ctx.arc(px, py, 6, 0, Math.PI * 2);
          ctx.fillStyle = "cyan";
          ctx.shadowColor = "white";
          ctx.shadowBlur = 10;
          ctx.fill();
          ctx.restore();
        }

        // Show tick after 2 seconds
        if (showTick) {
          ctx.save();
          ctx.font = "80px Arial";
          ctx.fillStyle = "lime";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.shadowColor = "lime";
          ctx.shadowBlur = 40;
          ctx.fillText("âœ”", x, y);
          ctx.restore();
        }
      }
    }

    async function main() {
      await setupCamera();
      video.play();
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      model = await handpose.load();

      // Run the animation loop at high FPS, but palm detection at a slower pace
      async function loop() {
        await detectHands();
        drawAnimation();
        requestAnimationFrame(loop);
      }
      loop();
    }

    main();
  </script>
</body>
</html>
